# ë‹¤ì´ì†Œ ë§¤ì¥ ìƒí’ˆ ìœ„ì¹˜ ì•ˆë‚´ ì‹œìŠ¤í…œ â€” ê¸°ëŠ¥ ì„¤ê³„ì„œ (v3)

> **í”„ë¡œì íŠ¸ëª…**: ë‹¤ì´ì†Œ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ì„œë¹„ìŠ¤  
> **ë¬¸ì„œ ë²„ì „**: v3.0  
> **ì‘ì„± ê¸°ì¤€**: `poc/` í´ë” ë‚´ 6ê°œ ëª¨ë“ˆ + ìœ ì € í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨ + ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨  
> **ëŒ€ìƒ ë””ë°”ì´ìŠ¤**: íƒœë¸”ë¦¿ í‚¤ì˜¤ìŠ¤í¬ (ë©”ì¸) + ëª¨ë°”ì¼ ìŠ¤ë§ˆíŠ¸í° (QR ì—°ë™)

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

ê³ ê°ì´ ë‹¤ì´ì†Œ ë§¤ì¥ ë‚´ íƒœë¸”ë¦¿ í‚¤ì˜¤ìŠ¤í¬ì—ì„œ **ìŒì„± ë˜ëŠ” í…ìŠ¤íŠ¸**ë¡œ ìƒí’ˆì„ ê²€ìƒ‰í•˜ë©´,  
AIê°€ ì˜ë„ë¥¼ ë¶„ì„í•˜ê³  ìƒí’ˆì„ ì°¾ì•„ **ë§¤ëŒ€ ìœ„ì¹˜ë¥¼ ì•ˆë‚´**í•œ ë’¤,  
**QR ì½”ë“œ**ë¥¼ í†µí•´ ê³ ê°ì˜ ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ **ì§€ë„/AR ë‚´ë¹„ê²Œì´ì…˜**ì„ ì œê³µí•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### í•µì‹¬ íŒŒì´í”„ë¼ì¸

```
ìŒì„±/í…ìŠ¤íŠ¸ ì…ë ¥ â†’ STT â†’ Intent & Keyword â†’ Hybrid Search â†’ LLM Re-ranker â†’ ê²°ê³¼ í‘œì‹œ â†’ QR ìƒì„± â†’ ëª¨ë°”ì¼ ë„¤ë¹„
```

---

## 2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ (Component View)

### 2.1 ì „ì²´ ì•„í‚¤í…ì²˜

```
                              Clients
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Next.js      â”‚ React        â”‚
                 â”‚ Kiosk PWA    â”‚ Mobile AR    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚              â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  AWS ALB / API Gateway       â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           FastAPI Backend Cluster              â”‚
        â”‚                                                â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚           Main API Router                 â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚            â”‚                    â”‚               â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚  AI Agent Layer    â”‚  â”‚  Core Services    â”‚  â”‚
        â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚
        â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
        â”‚  â”‚  â”‚ Supervisor   â”‚  â”‚  â”‚  â”‚ Google       â”‚ â”‚  â”‚
        â”‚  â”‚  â”‚ (LangGraph)  â”‚  â”‚  â”‚  â”‚ Streaming    â”‚ â”‚  â”‚
        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚ STT          â”‚ â”‚  â”‚
        â”‚  â”‚         â”‚          â”‚  â”‚  â”‚ (Whisper     â”‚ â”‚  â”‚
        â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  Fallback)  â”‚ â”‚  â”‚
        â”‚  â”‚  â”‚ Pipeline     â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
        â”‚  â”‚  â”‚              â”‚  â”‚  â”‚                    â”‚  â”‚
        â”‚  â”‚  â”‚ â‘  Intent &   â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
        â”‚  â”‚  â”‚   Keyword    â”‚  â”‚  â”‚  â”‚ QR Generator â”‚ â”‚  â”‚
        â”‚  â”‚  â”‚ (Gemini 2.0) â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
        â”‚  â”‚  â”‚      â†“       â”‚  â”‚  â”‚                    â”‚  â”‚
        â”‚  â”‚  â”‚ â‘¡ Hybrid     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚  â”‚  â”‚   Searcher   â”‚  â”‚                          â”‚
        â”‚  â”‚  â”‚ (BM25+Vector)â”‚  â”‚                          â”‚
        â”‚  â”‚  â”‚      â†“       â”‚  â”‚                          â”‚
        â”‚  â”‚  â”‚ â‘¢ LLM        â”‚  â”‚                          â”‚
        â”‚  â”‚  â”‚   Re-ranker  â”‚  â”‚                          â”‚
        â”‚  â”‚  â”‚ (Gemini 2.0) â”‚  â”‚                          â”‚
        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                          â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚      Data Infrastructure      â”‚
                 â”‚                                â”‚
                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
                 â”‚  â”‚Postgreâ”‚  â”‚Redis â”‚  â”‚Chromaâ”‚ â”‚
                 â”‚  â”‚SQL    â”‚  â”‚      â”‚  â”‚DB    â”‚ â”‚
                 â”‚  â”‚(Meta) â”‚  â”‚(Cache)â”‚  â”‚(Vec) â”‚ â”‚
                 â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ì»´í¬ë„ŒíŠ¸ ë§¤í•‘

| ì•„í‚¤í…ì²˜ ì»´í¬ë„ŒíŠ¸ | êµ¬í˜„ ìœ„ì¹˜ | ì—­í•  |
|------------------|----------|------|
| **Next.js Kiosk PWA** | `frontend/` | í‚¤ì˜¤ìŠ¤í¬ íƒœë¸”ë¦¿ UI |
| **React Mobile AR** | `frontend/mobile/` | ëª¨ë°”ì¼ AR/ì§€ë„ ë„¤ë¹„ê²Œì´ì…˜ |
| **AWS ALB / API Gateway** | ì¸í”„ë¼ | ë¡œë“œë°¸ëŸ°ì‹±, ë¼ìš°íŒ… |
| **Main API Router** | `backend/api.py` | FastAPI ì—”ë“œí¬ì¸íŠ¸ |
| **Supervisor (LangGraph)** | `backend/ai_service/supervisor.py` | AI íŒŒì´í”„ë¼ì¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ |
| **Intent & Keyword** | `backend/ai_service/intent_keyword_node.py` | ì˜ë„ íŒë³„ + NLU + í‚¤ì›Œë“œ |
| **Hybrid Searcher** | `backend/ai_service/hybrid_searcher_node.py` | BM25 + Vector ê²€ìƒ‰ |
| **LLM Re-ranker** | `backend/ai_service/reranker_node.py` | CoT ê¸°ë°˜ ë¦¬ë­í‚¹ |
| **Google Streaming STT** | `backend/stt/` | ìŒì„±â†’í…ìŠ¤íŠ¸ (Whisper Fallback) |
| **QR Generator** | `frontend/` (qrcode.js) | QR ì½”ë“œ ìƒì„± |
| **PostgreSQL** | Data Infra | ìƒí’ˆ ë©”íƒ€ë°ì´í„° ì €ì¥ |
| **Redis** | Data Infra | ê²€ìƒ‰ ê²°ê³¼ ìºì‹± |
| **ChromaDB** | Data Infra | ë²¡í„° ì„ë² ë”© ê²€ìƒ‰ |

---

## 3. ìœ ì € í”Œë¡œìš° ìƒì„¸ (ì´ 14ë‹¨ê³„)

ìœ ì € í”Œë¡œìš°ëŠ” **4ê°œ Stage**ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.

### Stage 1. ì…ë ¥ ë° ì˜ë„ ë¶„ì„ (í‚¤ì˜¤ìŠ¤í¬)

| ë‹¨ê³„ | ì´ë¦„ | ì„¤ëª… | ë‹´ë‹¹ ì»´í¬ë„ŒíŠ¸ |
|:---:|------|------|-------------|
| **1** | ì‹œì‘ (íƒœë¸”ë¦¿ ì‹¤í–‰) | í‚¤ì˜¤ìŠ¤í¬ ëŒ€ê¸° í™”ë©´. í„°ì¹˜ ë˜ëŠ” ìŒì„±ìœ¼ë¡œ í™œì„±í™” | Next.js Kiosk PWA |
| **2** | ìƒí’ˆê²€ìƒ‰ (ìŒì„±/í…ìŠ¤íŠ¸ ì…ë ¥) | ì‚¬ìš©ìê°€ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§í•˜ê±°ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥ | Google Streaming STT / Kiosk PWA |
| **3** | ì˜ë„ë¶„ì„ (ìƒí’ˆìœ„ì¹˜í™•ì¸) | ì…ë ¥ì´ **ìƒí’ˆ ìœ„ì¹˜ ë¬¸ì˜ì¸ì§€** íŒë³„ (Y/N ë¶„ê¸°) | AI Agent â†’ Intent & Keyword |
| **3-1** | ìœ„ì¹˜ ì•ˆë‚´ ë¶ˆê°€ ì•ˆë‚´ | ì˜ë„ê°€ ìƒí’ˆê²€ìƒ‰ì´ **ì•„ë‹Œ ê²½ìš°** â†’ "ì§ˆë¬¸ ì˜ˆì‹œ ì œì•ˆ" ë˜ëŠ” "ì§ì› í˜¸ì¶œ" ì•ˆë‚´ | Kiosk PWA |
| **4** | í‚¤ì›Œë“œ ì¶”ì¶œ | ì˜ë„ê°€ ìƒí’ˆê²€ìƒ‰ì¸ ê²½ìš°(Yes) â†’ NLU ìŠ¬ë¡¯ ì±„ìš°ê¸° + í‚¤ì›Œë“œ í™•ì¥ | AI Agent â†’ Intent & Keyword |

### Stage 2. ê²€ìƒ‰

| ë‹¨ê³„ | ì´ë¦„ | ì„¤ëª… | ë‹´ë‹¹ ì»´í¬ë„ŒíŠ¸ |
|:---:|------|------|-------------|
| **5** | ê²€ìƒ‰ ì‹¤í–‰ | ì¶”ì¶œëœ í‚¤ì›Œë“œë¡œ ìƒí’ˆ ì¹´íƒˆë¡œê·¸ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ (BM25 + Vector) | AI Agent â†’ Hybrid Searcher |
| **6** | ê²€ìƒ‰ ê²°ê³¼ íŒë³„ | ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆëŠ”ì§€ / ëª‡ ê°œì¸ì§€ íŒë³„. ê²°ê³¼ ì—†ìœ¼ë©´ "ì—†ìŒ" ì•ˆë‚´ | AI Agent â†’ LLM Re-ranker |
| **7** | ê²°ê³¼í™”ë©´ ì¶œë ¥ | ê²€ìƒ‰ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ (ì˜ˆ: ìƒìœ„ 3ê°œ ë˜ëŠ” "ê²°ê³¼ ì—†ìŒ") | Kiosk PWA |

### Stage 3. ê²°ê³¼ ì•ˆë‚´ (í‚¤ì˜¤ìŠ¤í¬)

| ë‹¨ê³„ | ì´ë¦„ | ì„¤ëª… | ë‹´ë‹¹ ì»´í¬ë„ŒíŠ¸ |
|:---:|------|------|-------------|
| **8** | ìƒí’ˆ ì„ íƒ | ê²€ìƒ‰ ê²°ê³¼ ì¤‘ ì›í•˜ëŠ” ìƒí’ˆì„ ì„ íƒ (í„°ì¹˜) | Kiosk PWA |
| **9** | ë§¤ëŒ€ ë²ˆí˜¸ ë° QR ì½”ë“œ ì•ˆë‚´ | ì„ íƒí•œ ìƒí’ˆì˜ **ì¸µ/êµ¬ì—­/ë§¤ëŒ€ ë²ˆí˜¸** í‘œì‹œ + QR ì½”ë“œ ìƒì„± | Kiosk PWA + QR Generator |
| **13** | íƒœë¸”ë¦¿ ì¢…ë£Œ | ìë™ íƒ€ì„ì•„ì›ƒ ë˜ëŠ” "ë‹¤ìŒ ê³ ê°" í„°ì¹˜ë¡œ ì´ˆê¸°í™”ë©´ ë³µê·€ | Kiosk PWA |

> **ë¶„ê¸°**: 8ë‹¨ê³„ì—ì„œ "ì›í•˜ëŠ” ìƒí’ˆ ì—†ìŒ" ì„ íƒ ì‹œ â†’ 13ë²ˆ(íƒœë¸”ë¦¿ ì¢…ë£Œ)ìœ¼ë¡œ ì´ë™

### Stage 4. ëª¨ë°”ì¼ ì—°ë™

| ë‹¨ê³„ | ì´ë¦„ | ì„¤ëª… | ë‹´ë‹¹ ì»´í¬ë„ŒíŠ¸ |
|:---:|------|------|-------------|
| **10** | ëª¨ë°”ì¼ ì¹´ë©”ë¼/QR ë¦¬ë” ì‹¤í–‰ | ì‚¬ìš©ìê°€ ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ QR ì½”ë“œë¥¼ ì´¬ì˜ ì¤€ë¹„ | ì‚¬ìš©ì ë””ë°”ì´ìŠ¤ |
| **11** | QR ìŠ¤ìº” | QR ì½”ë“œ ìŠ¤ìº” â†’ ëª¨ë°”ì¼ ì›¹ í˜ì´ì§€ ìë™ ì˜¤í”ˆ | React Mobile AR |
| **12-1** | ì§€ë„ ë³´ë©° ì´ë™ | **2D ë§¤ì¥ ì§€ë„** + ì‹œì‘ì /ëª©ì ì§€ ë§ˆì»¤ í‘œì‹œ (ì¸µê°„ ì´ë™ ì§€ì›) | React Mobile AR (Map View) |
| **12-2** | ë„¤ë¹„ ë³´ë©° ì´ë™ | **AR ë‚˜ì¹¨ë°˜** ëª¨ë“œ â€” ì¹´ë©”ë¼ ë°°ê²½ ìœ„ì— ë°©í–¥ í™”ì‚´í‘œ í‘œì‹œ | React Mobile AR (AR View) |
| **14** | ëª¨ë°”ì¼ ì•ˆë‚´ ì¢…ë£Œ | ê³ ê°ì´ ìƒí’ˆ ë„ì°© í›„ í˜ì´ì§€ ë‹«ê¸° | React Mobile AR |

---

## 4. AI Agent Layer ìƒì„¸ ëª…ì„¸

### 4.1 Supervisor (LangGraph)

> **ì—­í• **: AI íŒŒì´í”„ë¼ì¸ ì „ì²´ë¥¼ **StateGraph**ë¡œ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Entry Point â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ Intent &    â”‚
                    â”‚ Keyword     â”‚
                    â”‚ Node        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                     â”‚ Valid? Y/N â”‚
                     â””â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                     Y  â”‚     â”‚ N
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”  â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Hybrid    â”‚  â”‚ Response  â”‚
              â”‚ Search    â”‚  â”‚ (ë¬´ê´€ ì•ˆë‚´)â”‚
              â”‚ Node      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
                    â”‚                â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”‚
              â”‚ LLM       â”‚         â”‚
              â”‚ Re-ranker â”‚         â”‚
              â”‚ Node      â”‚         â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
                    â”‚                â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”‚
              â”‚ Ambiguity â”‚         â”‚
              â”‚ Check     â”‚         â”‚
              â””â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”˜         â”‚
          Clear  â”‚     â”‚ Ambiguous  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”  â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚Responseâ”‚  â”‚Clarify    â”‚  â”‚
          â”‚ Node  â”‚  â”‚(ê¼¬ë¦¬ì§ˆë¬¸) â”‚  â”‚
          â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
              â”‚            â”‚         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                    â”Œâ”€â”€â–¼â”€â”€â”
                    â”‚ END â”‚
                    â””â”€â”€â”€â”€â”€â”˜
```

**PipelineState** (ê·¸ë˜í”„ ìƒíƒœ):
- `input_text`, `session_id`, `history[]`
- `intent_valid` (Y/N), `intent`, `slots`
- `search_candidates[]`, `rerank_result`
- `is_ambiguous`, `clarification_count`
- `final_response` (NLUResponse)

---

### 4.2 Intent & Keyword ë…¸ë“œ

> **ì—­í• **: ì‚¬ìš©ì ë°œí™”ì˜ **ì˜ë„ íŒë³„ + NLU ë¶„ì„ + í‚¤ì›Œë“œ í™•ì¥**ì„ í•˜ë‚˜ì˜ ë…¸ë“œì—ì„œ ìˆ˜í–‰

**Step 1 â€” Intent Gate (Y/N)**:
- ëª¨ë¸: Gemini 2.0 Flash (temperature=0.0, max_output_tokens=5)
- Y (ì‘ëŒ€ í•„ìš”): ìƒí’ˆ ì°¾ê¸°, ì¬ê³  í™•ì¸, ë§¤ì¥ ì‹œì„¤ ë¬¸ì˜, ê²°ì œ/ë©¤ë²„ì‹­ ë¬¸ì˜
- N (ë¬´ì‹œ): ì‚¬ì  ì¡ë‹´, ì™¸ë¶€ ì •ë³´, íƒ€ ë¸Œëœë“œ, ìš•ì„¤

**Step 2 â€” NLU ë¶„ì„** (Yì¸ ê²½ìš°ë§Œ):
- ì˜ë„ ë¶„ë¥˜: `PRODUCT_LOCATION` / `OTHER_INQUIRY` / `UNSUPPORTED`
- ìŠ¬ë¡¯ ì±„ìš°ê¸°: `item`, `attrs`, `category_hint`, `query_rewrite`, `min_price`, `max_price`
- `response_schema`ë¡œ JSON ì¶œë ¥ ê°•ì œ

**Step 3 â€” í‚¤ì›Œë“œ í™•ì¥** (PRODUCT_LOCATIONì¸ ê²½ìš°):
- ìƒí’ˆëª… â†’ [ì›ë˜ì´ë¦„, ê³µê°„/ì¥ì†Œ, ìƒìœ„ê°œë…, ì¹´í…Œê³ ë¦¬, ê¸°ëŠ¥/íŠ¹ì„±]
- ì˜ˆì‹œ: `"ìš•ì‹¤ë§¤íŠ¸"` â†’ `["ìš•ì‹¤ë§¤íŠ¸", "ìš•ì‹¤", "ë§¤íŠ¸", "ìš•ì‹¤ìš©í’ˆ", "ë¯¸ë„ëŸ¼ë°©ì§€"]`

---

### 4.3 Hybrid Searcher ë…¸ë“œ

> **ì—­í• **: ìƒí’ˆ ì¹´íƒˆë¡œê·¸ì—ì„œ í›„ë³´êµ°ì„ **ê²€ìƒ‰(Retrieval)**

| ê²€ìƒ‰ ë°©ì‹ | ì„¤ëª… | ì¸í”„ë¼ |
|-----------|------|--------|
| BM25 | í‚¤ì›Œë“œ ê¸°ë°˜ í† í° ë§¤ì¹­ | PostgreSQL / SQLite |
| Dense Vector | ì„ë² ë”© ìœ ì‚¬ë„ ê²€ìƒ‰ | ChromaDB |
| Hybrid RRF | BM25 + Denseë¥¼ RRFë¡œ ê²°í•© | ê²°í•© ë ˆì´ì–´ |

- ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ: `infer_product_keywords()`ë¡œ í‚¤ì›Œë“œ ì¬ì¶”ë¡  í›„ ì¬ì‹œë„
- í˜„ì¬ ë‹¨ê³„: SQLite LIKE ê²€ìƒ‰ â†’ ì¶”í›„ PostgreSQL + ChromaDB í•˜ì´ë¸Œë¦¬ë“œ

---

### 4.4 LLM Re-ranker ë…¸ë“œ

> **ì—­í• **: ê²€ìƒ‰ëœ í›„ë³´êµ°ì—ì„œ **ê°€ì¥ ì í•©í•œ ìƒí’ˆ 1ê°œ**ë¥¼ LLMì´ CoT ì¶”ë¡ ìœ¼ë¡œ ì„ íƒ

- **ëª¨ë¸**: Gemini 2.0 Flash (JSON ì¶œë ¥ ëª¨ë“œ)
- **í”„ë¡¬í”„íŠ¸ ì›ì¹™**:
  1. **ì˜ë„ ìš°ì„ **: ì‚¬ìš©ìì˜ í•µì‹¬ ë‹ˆì¦ˆ íŒŒì•…
  2. **ë¬¸ë§¥ ì¸ì‹**: ë„“ì€ ì¿¼ë¦¬ëŠ” ê°€ì¥ ë³´í¸ì ì¸ ìƒí’ˆ ìš°ì„ 
  3. **ë¶€ì • í•„í„°ë§**: "í”Œë¼ìŠ¤í‹± ë§ê³ " â†’ í”Œë¼ìŠ¤í‹± ì œí’ˆ ì œì™¸
  4. **Null ì•ˆì „**: ì í•©í•œ í›„ë³´ ì—†ìœ¼ë©´ `null` ë°˜í™˜
- **Few-Shot ì‹œë‚˜ë¦¬ì˜¤**: íŠ¹ì • ê¸°ëŠ¥, ë””ìŠ¤íŠ¸ë™í„°/í•¨ì •, ì€ì–´/ë¹„ìœ , ë°œìŒ í‘œê¸°

```json
{
  "selected_id": "string ë˜ëŠ” null",
  "reason": "ì„ íƒ ì‚¬ìœ  (í•œêµ­ì–´)"
}
```

---

## 5. Core Services ìƒì„¸ ëª…ì„¸

### 5.1 Google Streaming STT (Whisper Fallback)

> **ì—­í• **: ê³ ê°ì˜ ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ | êµ¬í˜„: `backend/stt/`

- **ì˜¤ë””ì˜¤ ì •ê·œí™”**: WAV/PCM LINEAR16/16kHz/ëª¨ë…¸ (pydub + FFmpeg)
- **STT í”„ë¡œë°”ì´ë”**: Google Streaming STT (Primary) + Whisper (Fallback)
- **í’ˆì§ˆ ê²Œì´íŠ¸**: OK / RETRY / FAIL
  - ì‹¤íŒ¨ ì‚¬ìœ : `EMPTY_TRANSCRIPT`, `TOO_SHORT`, `LOW_CONFIDENCE`, `NONSENSE_PATTERN`
- **ì •ì±… ê²Œì´íŠ¸**: `PRODUCT_SEARCH` / `FIXED_LOCATION` / `UNSUPPORTED`
- **WebSocket**: `/ws/stt` â€” ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° STT

### 5.2 QR Generator

> **ì—­í• **: ìƒí’ˆ ìœ„ì¹˜ ì •ë³´ë¥¼ QR ì½”ë“œë¡œ ì¸ì½”ë”©

- **êµ¬í˜„**: í”„ë¡ íŠ¸ì—”ë“œ `qrcode.js` ë¼ì´ë¸ŒëŸ¬ë¦¬
- **QR ë‚´ìš©**: `{í˜¸ìŠ¤íŠ¸}/mobile/guide?name={ìƒí’ˆëª…}&shelf={ë§¤ëŒ€ID}&start={í‚¤ì˜¤ìŠ¤í¬ìœ„ì¹˜}`

---

## 6. Data Infrastructure

| ì»´í¬ë„ŒíŠ¸ | ì—­í•  | í˜„ì¬ ìƒíƒœ | ëª©í‘œ |
|----------|------|----------|------|
| **PostgreSQL** | ìƒí’ˆ ë©”íƒ€ë°ì´í„° ì €ì¥ | SQLite (`products.db`) | PostgreSQL ë§ˆì´ê·¸ë ˆì´ì…˜ |
| **Redis** | ê²€ìƒ‰ ê²°ê³¼ / ì„¸ì…˜ ìºì‹± | ë¯¸êµ¬í˜„ | Redis ìºì‹œ ë ˆì´ì–´ ì¶”ê°€ |
| **ChromaDB** | ë²¡í„° ì„ë² ë”© ê²€ìƒ‰ | SQLite LIKE ê²€ìƒ‰ | ChromaDB ë²¡í„° ê²€ìƒ‰ |

---

## 7. í”„ë¡ íŠ¸ì—”ë“œ ìƒì„¸

### 7.1 Next.js Kiosk PWA

- **ê²€ìƒ‰ ì…ë ¥**: í…ìŠ¤íŠ¸ ì…ë ¥ + ìŒì„± ì—°ë™ (WebSocket STT)
- **ì¶”ì²œ ê²€ìƒ‰ì–´**: ìƒ´í‘¸, ëƒ„ë¹„, ì±„ë°˜, ë³¼íœ ë“± ë¹ ë¥¸ ê²€ìƒ‰ ë²„íŠ¼
- **ê²°ê³¼ í‘œì‹œ**: ì¸µ ë°°ì§€ (B1/B2) + ìƒí’ˆëª… + ë§¤ëŒ€ ë²ˆí˜¸
- **QR ì½”ë“œ**: qrcode.jsë¡œ ìƒì„±

### 7.2 React Mobile AR

**2D ì§€ë„ ëª¨ë“œ**:
- ì¸µë³„ ì§€ë„ ì´ë¯¸ì§€ (`map_b1.jpg`, `map_b2.jpg`)
- 3ê°€ì§€ ë§ˆì»¤: ğŸ”µ ì¶œë°œì , ğŸ”´ ëª©ì ì§€, ğŸŸ  í™˜ìŠ¹ì 
- ì¸µ íƒ­ ì „í™˜

**AR ë‚˜ì¹¨ë°˜ ëª¨ë“œ**:
- í›„ë©´ ì¹´ë©”ë¼ í”¼ë“œ ìœ„ SVG ë‚˜ì¹¨ë°˜ í™”ì‚´í‘œ ì˜¤ë²„ë ˆì´
- `DeviceOrientationEvent` ê¸°ê¸° ë°©í–¥ ì„¼ì„œ í™œìš©
- ë‹¤ë¥¸ ì¸µì´ë©´ ê³„ë‹¨ ë°©í–¥ìœ¼ë¡œ í™”ì‚´í‘œ ì•ˆë‚´

### 7.3 ë§¤ì¥ ë°ì´í„° êµ¬ì¡°

**ë§¤ëŒ€(Shelf) ë°ì´í„°**: B1 11ê°œ + B2 15ê°œ = ì´ 26ê°œ êµ¬ì—­

| í•„ë“œ | ì„¤ëª… |
|------|------|
| `id` | ë§¤ëŒ€ ì½”ë“œ (A01, KI01) |
| `floor` | ì†Œì† ì¸µ (B1/B2) |
| `section` | ì¹´í…Œê³ ë¦¬ëª… |
| `x`, `y` | ì§€ë„ ìœ„ ì¢Œí‘œ (%) |
| `ar_x`, `ar_y` | AR ë°©í–¥ ê³„ì‚°ìš© ì¢Œí‘œ |

---

## 8. API ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„

### 8.1 Main API Router

| ë©”ì„œë“œ | ê²½ë¡œ | ì„¤ëª… | ë‹´ë‹¹ ì»´í¬ë„ŒíŠ¸ |
|--------|------|------|-------------|
| `WS` | `/ws/stt` | ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° STT | Core Services â†’ STT |
| `POST` | `/api/stt/process` | ë°°ì¹˜ ìŒì„±â†’í…ìŠ¤íŠ¸ | Core Services â†’ STT |
| `POST` | `/api/query` | **í†µí•© AI íŒŒì´í”„ë¼ì¸** (Intentâ†’Searchâ†’Rerank) | AI Agent â†’ Supervisor |
| `GET` | `/api/location/{shelf_id}` | ë§¤ëŒ€ ìœ„ì¹˜ ì¡°íšŒ | PostgreSQL |
| `GET` | `/health` | í—¬ìŠ¤ ì²´í¬ | Main API Router |

### 8.2 í”„ë¡ íŠ¸ì—”ë“œ í˜ì´ì§€

| ê²½ë¡œ | ì„¤ëª… | ë””ë°”ì´ìŠ¤ |
|------|------|----------|
| `/kiosk` | í‚¤ì˜¤ìŠ¤í¬ ë©”ì¸ í™”ë©´ | íƒœë¸”ë¦¿ |
| `/mobile/guide?name=&shelf=&start=` | ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ | ìŠ¤ë§ˆíŠ¸í° |

---

## 9. ê¸°ìˆ  ìŠ¤íƒ

| ì˜ì—­ | ê¸°ìˆ  | ë¹„ê³  |
|------|------|------|
| **AI/LLM** | Google Gemini 2.0 Flash | Intent, NLU, Reranking ê³µí†µ |
| **AI ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜** | LangGraph (StateGraph) | Supervisor íŒ¨í„´ |
| **STT** | Google Streaming STT + Whisper | Primary + Fallback |
| **ê²€ìƒ‰** | BM25 + ChromaDB (Vector) | í•˜ì´ë¸Œë¦¬ë“œ RRF |
| **ë°±ì—”ë“œ** | FastAPI (Python 3.11+) | ë¹„ë™ê¸° ì²˜ë¦¬ (asyncio) |
| **í”„ë¡ íŠ¸ì—”ë“œ** | Next.js (Kiosk) + React (Mobile) | PWA + AR |
| **DB** | PostgreSQL (Meta) + Redis (Cache) + ChromaDB (Vector) | 3-tier |
| **ê²Œì´íŠ¸ì›¨ì´** | AWS ALB / API Gateway | ë¡œë“œë°¸ëŸ°ì‹± |
| **ì˜¤ë””ì˜¤ ì²˜ë¦¬** | pydub + FFmpeg | ìŒì„± ì •ê·œí™” |

---

## 10. êµ¬í˜„ ìˆœì„œ

### Phase 1: AI Agent Layer (ìš°ì„ )
```
1. backend/ai_service/ íŒ¨í‚¤ì§€ êµ¬ì¡° ìƒì„±
2. config.py â€” Gemini API ì´ˆê¸°í™”
3. schemas.py â€” PipelineState + ê²°ê³¼ ëª¨ë¸
4. prompts.py â€” í†µí•© í”„ë¡¬í”„íŠ¸ 5ê°œ (Intent/NLU/Tail/Keyword/Rerank)
5. intent_keyword_node.py â€” Intent Gate + NLU + í‚¤ì›Œë“œ í™•ì¥
6. hybrid_searcher_node.py â€” BM25 + Vector ê²€ìƒ‰
7. reranker_node.py â€” LLM CoT ë¦¬ë­í‚¹
8. supervisor.py â€” LangGraph StateGraph ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
```

### Phase 2: í”„ë¡ íŠ¸ì—”ë“œ (ë³‘í–‰)
```
1. Next.js Kiosk PWA êµ¬í˜„
2. React Mobile AR êµ¬í˜„ (2D ì§€ë„ + AR ë‚˜ì¹¨ë°˜)
3. ë§¤ì¥ ë°ì´í„° ì •ë¦¬ ë° ì§€ë„ ì´ë¯¸ì§€ ì¤€ë¹„
4. API ì—°ë™ ë° QR í•¸ë“œì˜¤í”„ í…ŒìŠ¤íŠ¸
```

### Phase 3: Data Infrastructure
```
1. SQLite â†’ PostgreSQL ë§ˆì´ê·¸ë ˆì´ì…˜
2. ChromaDB ë²¡í„° ê²€ìƒ‰ í†µí•©
3. Redis ìºì‹œ ë ˆì´ì–´ ì¶”ê°€
```

### Phase 4: í†µí•© & ê²€ì¦
```
1. E2E í…ŒìŠ¤íŠ¸: "ìŒì„± ì…ë ¥ â†’ ìƒí’ˆ ìœ„ì¹˜ â†’ QR â†’ ëª¨ë°”ì¼ ì§€ë„"
2. ë¦¬ë­í‚¹ ì •í™•ë„: Golden Test Cases ìë™ í‰ê°€
3. ì—£ì§€ ì¼€ì´ìŠ¤: ì€ì–´/ë¹„ìœ , ëª¨í˜¸í•œ ì¿¼ë¦¬, ê²°ê³¼ ì—†ìŒ
```

---

## 11. í•µì‹¬ ë°ì´í„° ëª¨ë¸

### PipelineState (LangGraph ìƒíƒœ)
```python
class PipelineState(TypedDict):
    request_id: str
    input_text: str
    session_id: str
    history: List[Dict]
    intent_valid: str           # "Y" / "N"
    intent: Intent
    slots: Dict[str, Any]
    search_candidates: List[Dict]
    rerank_result: Dict         # {selected_id, reason, latency}
    is_ambiguous: bool
    clarification_count: int
    final_response: NLUResponse
```

### NLUResponse (NLU ì‘ë‹µ)
```python
class NLUResponse(BaseModel):
    request_id: str
    intent: Intent              # PRODUCT_LOCATION | OTHER_INQUIRY | UNSUPPORTED
    slots: NLUSlots             # {item, attrs, category_hint, query_rewrite, min_price, max_price}
    needs_clarification: bool
    generated_question: str
    latency_ms: int
    token_usage: dict           # {prompt_tokens, completion_tokens, total_tokens}
    products: List[Product]
```

### RerankResult (ë¦¬ë­í‚¹ ì‘ë‹µ)
```python
class RerankResult(BaseModel):
    selected_id: str | None
    reason: str
    latency: float
```

---

*ë³¸ ë¬¸ì„œëŠ” `poc/` í´ë” ë‚´ 6ê°œ ëª¨ë“ˆ(intent, kms, kdg, lsy, bjy, lyg), ìœ ì € í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨, ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨(Component View)ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
